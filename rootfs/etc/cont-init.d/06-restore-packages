#!/command/with-contenv bash
# Restore and reinstall user-installed packages from backup
source /etc/s6-overlay/lib/env-utils.sh

DPKG_SELECTIONS="/etc/openclaw/dpkg-selections"

source_env_prefix RESTIC_

# Check if persistence is configured
if [ -z "$RESTIC_REPOSITORY" ] || [ -z "$RESTIC_PASSWORD" ]; then
  echo "[restore-packages] Persistence not configured, skipping"
  exit 0
fi

# Check if repository has any snapshots
if ! restic snapshots --latest 1 2>/dev/null | grep -q 'ID'; then
  echo "[restore-packages] No snapshots found, skipping"
  exit 0
fi

# Step 1: Restore dpkg-selections file first (from globally latest /etc snapshot, excluding current container)
echo "[restore-packages] Restoring package selections from latest snapshot..."
if restic restore latest --target / --include "$DPKG_SELECTIONS" 2>&1; then
  echo "[restore-packages] Package selections restored"
else
  echo "[restore-packages] Error: Could not restore package selections"
  exit 1
fi

# Step 2: Reinstall packages if selections file exists
if [ -f "$DPKG_SELECTIONS" ]; then
  echo "[restore-packages] Reinstalling packages from saved selections..."
  # Update apt cache
  apt-get update -qq
  # Sync dpkg's available database with apt's cache (required for dselect-upgrade)
  apt-cache dumpavail | dpkg --update-avail -
  # Now set selections and install
  dpkg --set-selections < "$DPKG_SELECTIONS"
  apt-get dselect-upgrade -y -qq || echo "[restore-packages] Warning: Some packages may have failed to install"
  echo "[restore-packages] Package reinstallation complete"
else
  echo "[restore-packages] No package selections found."
  exit 0
fi
