#!/bin/bash
set -e

# Proxy entire command line to real_tailscale and add the socket path from TS_SOCKET if not already present

# Load TS_ env vars
for f in /run/s6/container_environment/TS_/*; do
  [ -f "$f" ] && export "$(basename "$f")"="$(cat "$f")"
done

ARGS=("$@")

# Check if any argument starts with --socket=
SOCKET_PRESENT=false
for arg in "${ARGS[@]}"; do
	case $arg in
		--socket=*) SOCKET_PRESENT=true ;;
	esac
done

# Insert --socket as the first argument if not present
if [ "$SOCKET_PRESENT" = false ]; then
	SOCKET_ARG="--socket=${TS_SOCKET:-/tmp/tailscaled.sock}"
	ARGS=("$SOCKET_ARG" "${ARGS[@]}")
fi

exec "$(dirname "$0")/real_tailscale" "${ARGS[@]}"
